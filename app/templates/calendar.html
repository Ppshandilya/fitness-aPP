<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Workout Tracker Calendar</title>

  <style>
    body {
      background-color: #000000; /* pure black */
      color: white;
      font-family: "Segoe UI", sans-serif;
      display: flex;
      justify-content: center;
      padding: 40px;
    }

    /* BUY NOW BUTTON */
    #buy-now-btn {
      position: fixed;
      left: 25px;
      top: 7%;
      transform: translateY(-50%);
      padding: 14px 22px;
      background-color: #ff2e63;
      color: white;
      font-size: 1.1rem;
      font-weight: bold;
      border: none;
      border-radius: 12px;
      cursor: pointer;
      z-index: 2000;
      transition: 0.3s ease;
      box-shadow: 0 0 10px rgba(255, 46, 99, 0.7);
    }

    #buy-now-btn:hover {
      background-color: #ff1b50;
      transform: translateY(-50%) scale(1.08);
    }

    .calendar-container {
      text-align: center;
      width: 100%;
      max-width: 100vw;
      position: relative;
    }

    #year-title {
      font-size: 3rem;
      margin-bottom: 10px;
    }

    #stats-container {
      display: flex;
      gap: 40px;
      justify-content: center;
      margin-bottom: 25px;
      flex-wrap: wrap;
    }

    .stat-block {
      text-align: center;
      min-width: 120px;
    }

    .progress-circle {
      width: 120px;
      height: 120px;
      border-radius: 50%;
      background: conic-gradient(#2ecc71 var(--progress, 0deg), #444 var(--progress, 0deg));
      display: flex;
      align-items: center;
      justify-content: center;
      margin: auto;
      position: relative;
      transition: 0.7s ease;
      box-sizing: border-box;
    }

    .progress-inner {
      width: 94px;
      height: 94px;
      background-color: #000;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      box-sizing: border-box;
    }

    .circle-btn {
      width: 94px;
      height: 94px;
      border-radius: 50%;
      background-color: #4a7dff;
      border: none;
      color: white;
      font-size: 1rem;
      font-weight: bold;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: 0.25s ease;
      box-sizing: border-box;
    }

    .circle-btn:hover {
      transform: scale(1.05);
      background-color: #2f6bff;
    }

    #year-calendar {
      display: flex;
      flex-direction: row;
      gap: 40px;
      overflow-x: auto;
      scroll-snap-type: x mandatory;
      white-space: nowrap;
      padding: 20px 0;
    }

    .month-container {
      width: 450px;
      scroll-snap-align: center;
      border: 1px solid #222;
      border-radius: 12px;
      padding: 20px;
      background-color: #0a0a0a;
      box-shadow: 0 0 12px rgba(0, 255, 0, 0.15);
    }

    .calendar-grid {
      display: grid;
      grid-template-columns: repeat(7, 60px);
      gap: 10px;
      justify-content: center;
      margin-top: 15px;
    }

    .day-box {
      width: 50px;
      height: 50px;
      border-radius: 10px;
      background-color: #161b22;
      transition: 0.3s;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.2rem;
    }

    .day-box:hover { transform: scale(1.2); cursor:pointer; }

    .green-day {
      background-color: #2ecc71 !important;
      box-shadow: 0 0 15px rgba(46, 204, 113, 0.9);
      transform: scale(1.05);
    }

    .today-highlight { animation: flash 1s ease-in-out 3; outline: 3px solid #ffcc00; }

    @keyframes flash { 50% { transform: scale(1.25); opacity: 0.5; } }

    .modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      display: none;
      justify-content: center;
      align-items: center;
    }

    .modal-content {
      background: #161b22;
      padding: 20px 30px;
      border-radius: 10px;
      width: 350px;
      text-align: center;
    }

    button {
      background-color: #238636;
      border: none;
      color: white;
      padding: 10px 15px;
      border-radius: 6px;
      cursor: pointer;
      margin: 5px;
    }

    .close-btn { background-color: #6e7681; }

    .intensity-box {
      padding: 10px 15px;
      background-color: #21262d;
      border-radius: 8px;
      cursor: pointer;
      width: 60px;
      text-align: center;
      transition: 0.3s;
    }

    .intensity-box.selected { outline: 2px solid white; }

    #nav-buttons {
      display: flex;
      justify-content: center;
      gap: 20px;
      margin-bottom: 15px;
    }

    #current-btn {
      position: absolute;
      right: 10px;
      top: 10px;
      background-color: #0070f3;
    }
  </style>
</head>

<body>

  <!-- BUY NOW BUTTON -->
  <button id="buy-now-btn">Upload</button>
  <img id="preview-img" style="display:none; position:fixed; left:25px; top:13%; width:120px; border-radius:12px; border:2px solid #ff2e63; z-index:3000;" />

  <div class="calendar-container">
    <h1 id="year-title"></h1>
    <div id="stats-container"></div>

    <button id="current-btn">Current ðŸ”¥</button>

    <div id="nav-buttons">
      <button id="prev-btn">â¬… Prev</button>
      <button id="next-btn">Next âž¡</button>
    </div>

    <div id="year-calendar"></div>
  </div>

  <!-- Modal -->
  <div id="modal" class="modal">
    <div class="modal-content">
      <h2 id="modal-date"></h2>
      <p>Did you work out?</p>

      <button id="yes-btn">Yes</button>
      <button id="no-btn">No</button>

      <div id="intensity-section" style="display:none; margin-top:15px;">
        <label>Select Intensity:</label>
        <div style="display:flex; gap:10px; justify-content:center; margin:10px 0;">
          <div class="intensity-box" data-value="30">Low</div>
          <div class="intensity-box" data-value="60">Mid</div>
          <div class="intensity-box" data-value="100">High</div>
        </div>
        <button id="submit-btn">Submit</button>
      </div>

      <button class="close-btn" id="close-btn">Close</button>
    </div>
  </div>

  <script>
    
    let workoutMap = {};

    document.getElementById("buy-now-btn").onclick = async () => {
      try {
        const response = await fetch("https://fitness-app-5-j152.onrender.com/upload-img", {
          method: "GET"
        });

        const blob = await response.blob();
        const imageUrl = URL.createObjectURL(blob);

        console.log("Image loaded:", imageUrl);

        const preview = document.getElementById("preview-img");
        preview.src = imageUrl;
        preview.style.display = "block";

      } catch (err) {
        console.error("Error calling upload-img:", err);
        alert("Error occurred");
      }
    };

    async function loadWorkouts() {
      const res = await fetch("https://fitness-app-5-j152.onrender.com/workouts");
      const data = await res.json();
      data.forEach(item => {
        if (item.date_) workoutMap[item.date_] = Number(item.intensity ?? 0);
      });
    }

    function isLeapYear(y) {
      return (y % 4 === 0 && y % 100 !== 0) || (y % 400 === 0);
    }

    function calculateStats() {
      const today = new Date();
      const year = today.getFullYear();
      const month = today.getMonth();

      const startOfWeek = new Date(today);
      const dow = startOfWeek.getDay();
      startOfWeek.setHours(0, 0, 0, 0);
      startOfWeek.setDate(startOfWeek.getDate() - dow);

      const endOfWeek = new Date(startOfWeek);
      endOfWeek.setDate(endOfWeek.getDate() + 6);
      endOfWeek.setHours(23, 59, 59, 999);

      let wW = 0, wM = 0, wY = 0;

      Object.entries(workoutMap).forEach(([dateStr, intensity]) => {
        if (intensity >= 0) {
          const [y, m, d] = dateStr.split("-").map(Number);
          const dt = new Date(y, m - 1, d);

          if (dt >= startOfWeek && dt <= endOfWeek) wW++;
          if (dt.getFullYear() === year && dt.getMonth() === month) wM++;
          if (dt.getFullYear() === year) wY++;
        }
      });

      const totalDaysInMonth = new Date(year, month + 1, 0).getDate();
      const totalDaysInYear = isLeapYear(year) ? 366 : 365;

      return {
        week: { ratio: wW / 7, worked: wW, total: 7 },
        month: { ratio: wM / totalDaysInMonth, worked: wM, total: totalDaysInMonth },
        year: { ratio: wY / totalDaysInYear, worked: wY, total: totalDaysInYear }
      };
    }

    function renderStats() {
      const statsContainer = document.getElementById("stats-container");
      statsContainer.innerHTML = "";

      const stats = calculateStats();

      const blocks = [
        { label: "This Week", endpoint: "/week-consistency", data: stats.week },
        { label: "This Month", endpoint: "/month-consistency", data: stats.month },
        { label: "This Year", endpoint: "/year-consistency", data: stats.year }
      ];

      blocks.forEach(({ label, endpoint, data }) => {
        const percent = Math.round(data.ratio * 100);
        const div = document.createElement("div");
        div.classList.add("stat-block");

        div.innerHTML = `
          <div class="progress-circle" style="--progress:${percent * 3.6}deg;">
            <div class="progress-inner">
              <button class="circle-btn get-btn" data-endpoint="${endpoint}">Get</button>
            </div>
          </div>
          <p style="margin-top:10px;">${label}</p>
          <small>${data.worked}/${data.total} days</small>
        `;
        statsContainer.appendChild(div);
      });
    }

    document.addEventListener("click", async (e) => {
      if (e.target.classList.contains("get-btn")) {
        const endpoint = e.target.dataset.endpoint;
        try {
          const res = await fetch("https://fitness-app-5-j152.onrender.com" + endpoint);
          const percentage = await res.json();
          e.target.textContent = percentage + "%";
          const circle = e.target.closest(".progress-circle");
          circle.style.setProperty("--progress", `${percentage * 3.6}deg`);
        } catch (err) {
          console.error(err);
          alert("Error calling API");
        }
      }
    });

    async function generateCalendarYear() {
      await loadWorkouts();
      renderStats();

      const yearCalendar = document.getElementById("year-calendar");
      const yearTitle = document.getElementById("year-title");

      const now = new Date();
      const year = now.getFullYear();
      yearTitle.textContent = year;

      const monthNames = [
        "January","February","March","April","May","June",
        "July","August","September","October","November","December"
      ];

      for (let month = 0; month < 12; month++) {
        const container = document.createElement("div");
        container.classList.add("month-container");

        const title = document.createElement("h2");
        title.textContent = monthNames[month];
        container.appendChild(title);

        const grid = document.createElement("div");
        grid.classList.add("calendar-grid");

        let firstDay = new Date(year, month, 1).getDay();
        firstDay = (firstDay === 0 ? 6 : firstDay - 1);

        const totalDays = new Date(year, month + 1, 0).getDate();

        for (let i = 0; i < firstDay; i++) {
          const empty = document.createElement("div");
          empty.classList.add("day-box");
          grid.appendChild(empty);
        }

        for (let day = 1; day <= totalDays; day++) {
          const box = document.createElement("div");
          box.classList.add("day-box");
          box.textContent = day;

          const date = new Date(year, month, day);
          const key = date.toLocaleDateString("en-CA");

          if (workoutMap[key] !== undefined) {
            box.classList.add("green-day");
          }

          box.addEventListener("click", () => openModal(year, month, day, box));
          grid.appendChild(box);
        }

        container.appendChild(grid);
        yearCalendar.appendChild(container);
      }
    }

    const modal = document.getElementById("modal");
    const modalDate = document.getElementById("modal-date");
    const intensitySection = document.getElementById("intensity-section");
    let selectedDayBox = null;
    let selectedDate = null;
    let selectedIntensity = null;

    function openModal(year, month, day, box) {
      selectedDayBox = box;
      selectedDate = new Date(year, month, day).toLocaleDateString("en-CA");
      modalDate.textContent = `Date: ${selectedDate}`;
      modal.style.display = "flex";
      intensitySection.style.display = "none";
      selectedIntensity = null;
      document.querySelectorAll(".intensity-box").forEach(b => b.classList.remove("selected"));
    }

    document.getElementById("yes-btn").onclick = () => intensitySection.style.display = "block";

    document.getElementById("no-btn").onclick = async () => {
      await postData(selectedDate, false, 0);
      selectedDayBox.classList.add("green-day");
      workoutMap[selectedDate] = 0;
      modal.style.display = "none";
      renderStats();
    };

    document.querySelectorAll(".intensity-box").forEach((b) => {
      b.onclick = () => {
        document.querySelectorAll(".intensity-box").forEach(x => x.classList.remove("selected"));
        b.classList.add("selected");
        selectedIntensity = Number(b.dataset.value);
      };
    });

    document.getElementById("submit-btn").onclick = async () => {
      if (!selectedIntensity) return alert("Select intensity!");
      await postData(selectedDate, true, selectedIntensity);
      selectedDayBox.classList.add("green-day");
      workoutMap[selectedDate] = selectedIntensity;
      modal.style.display = "none";
      renderStats();
    };

    document.getElementById("close-btn").onclick = () => modal.style.display = "none";

    async function postData(date, worked, intensity) {
      await fetch("https://fitness-app-5-j152.onrender.com/workout", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ date_: date, worked_out: worked, intensity: intensity })
      });
    }

    const yearCal = document.getElementById("year-calendar");

    document.getElementById("prev-btn").onclick = () =>
      yearCal.scrollBy({ left: -500, behavior: "smooth" });

    document.getElementById("next-btn").onclick = () =>
      yearCal.scrollBy({ left: 500, behavior: "smooth" });

    document.getElementById("current-btn").onclick = () => {
      const today = new Date();
      const month = today.getMonth();
      const day = today.getDate();

      const monthEl = document.querySelectorAll(".month-container")[month];
      if (!monthEl) return;

      monthEl.scrollIntoView({ behavior: "smooth", inline: "center" });

      const dateBox = [...monthEl.querySelectorAll(".day-box")]
        .find(el => el.textContent == day);

      if (dateBox) {
        dateBox.classList.add("today-highlight");
        setTimeout(() => dateBox.classList.remove("today-highlight"), 3000);
      }
    };

    generateCalendarYear();
  </script>
</body>
</html>
